<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cashier Menu</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Cashier Menu</h1>
    <div id="item-list"></div>
    <div id="items-display"></div>
    <div id="total-display">Total: Rp0</div>
    <button id="pay-cash">Pay Cash</button>
    <button id="done-transaction">Done</button>
    <button id="go-inventory">Go to Inventory Menu</button>

    <div id="bill-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Bill</h2>
            <div id="bill-items"></div>
            <div id="bill-total"></div>
            <button id="print-bill">Print Bill</button>
        </div>
    </div>

    <script>
        let totalAmount = 0;
        let selectedItems = [];

        // Fetch inventory items
        fetch('/inventory')
            .then(response => response.json())
            .then(items => {
                const itemList = document.getElementById('item-list');
                items.forEach(item => {
                    const button = document.createElement('button');
                    button.className = 'item-button';
                    button.innerText = `${item[0]} - Qty: ${item[1]}`;
                    button.onclick = () => addItemToTransaction(item[0]);
                    itemList.appendChild(button);
                });
            });

        function addItemToTransaction(itemName) {
            const existingItem = selectedItems.find(i => i.name === itemName);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                selectedItems.push({ name: itemName, price: 30000, quantity: 1 }); // Sample price
            }
            updateItemsDisplay();
        }

        function updateItemsDisplay() {
            const itemsDisplay = document.getElementById('items-display');
            itemsDisplay.innerHTML = ''; // Clear current display

            selectedItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'selected-item';
                itemDiv.innerText = `${item.name} x${item.quantity} - Rp${item.price * item.quantity}`;
                itemsDisplay.appendChild(itemDiv);
            });

            totalAmount = selectedItems.reduce((total, item) => total + (item.price * item.quantity), 0);
            document.getElementById('total-display').innerText = `Total: Rp${totalAmount}`;
        }

        // Handle cash payment and show bill modal
        document.getElementById('pay-cash').addEventListener('click', () => {
            if (totalAmount > 0) {
                showBill();
            } else {
                alert('No amount to pay.');
            }
        });

        // Show the bill in a modal
        function showBill() {
            const billItems = document.getElementById('bill-items');
            billItems.innerHTML = ''; // Clear current bill display
            selectedItems.forEach(item => {
                billItems.innerHTML += `<div class="item">${item.name} x${item.quantity} - Rp${item.price * item.quantity}</div>`;
            });
            document.getElementById('bill-total').innerText = `Total: Rp${totalAmount}`;
            document.getElementById('bill-modal').style.display = 'block';
        }

        // Close the modal
        document.querySelector('.close-button').addEventListener('click', () => {
            document.getElementById('bill-modal').style.display = 'none';
        });

        // Print the bill
        document.getElementById('print-bill').addEventListener('click', () => {
            const billContent = document.getElementById('bill-modal').innerHTML;
            const printWindow = window.open('', 'Print Bill', 'height=600,width=400');
            printWindow.document.write('<html><head><title>Bill</title><style>');
            printWindow.document.write('body { font-family: Arial, sans-serif; padding: 20px; }');
            printWindow.document.write('.item { margin: 5px 0; }');
            printWindow.document.write('</style></head><body>');
            printWindow.document.write(billContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        });

        // Done button to finish transaction and record it in the database
        document.getElementById('done-transaction').addEventListener('click', () => {
            if (totalAmount > 0) {
                fetch('/record_transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        item: selectedItems[0].name,  // Assuming single item for simplicity
                        amount: totalAmount
                    })
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    selectedItems = [];
                    totalAmount = 0;
                    updateItemsDisplay();
                    document.getElementById('bill-modal').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            } else {
                alert('No transaction to record.');
            }
        });

        // Navigate to Inventory Menu
        document.getElementById('go-inventory').addEventListener('click', () => {
            window.location.href = 'inventory.html';
        });
    </script>
</body>
</html>
